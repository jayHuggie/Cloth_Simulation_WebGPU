<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cloth Simulation - WebGPU</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            overflow: hidden;
            background: #1a1a1a;
            color: #fff;
        }
        
        #canvas {
            display: block;
            width: 100vw;
            height: 100vh;
        }
        
        #ui {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.8);
            padding: 20px;
            border-radius: 8px;
            max-width: 300px;
            max-height: 90vh;
            overflow-y: auto;
            font-size: 14px;
        }
        
        #ui h2 {
            margin-bottom: 15px;
            font-size: 18px;
            border-bottom: 1px solid #444;
            padding-bottom: 10px;
        }
        
        .control-group {
            margin-bottom: 15px;
        }
        
        .control-group label {
            display: block;
            margin-bottom: 5px;
            color: #ccc;
        }
        
        .control-group input[type="range"] {
            width: 100%;
            margin-bottom: 5px;
        }
        
        .control-group input[type="number"] {
            width: 100%;
            padding: 5px;
            background: #333;
            border: 1px solid #555;
            color: #fff;
            border-radius: 4px;
        }
        
        .control-group button {
            padding: 8px 12px;
            margin: 2px;
            background: #4a9eff;
            border: none;
            color: #fff;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .control-group button:hover {
            background: #5aaeff;
        }
        
        .control-group button:active {
            background: #3a8eef;
        }
        
        .button-group {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }
        
        .button-group button {
            flex: 1;
            min-width: 60px;
        }
        
        .info {
            margin-top: 10px;
            padding: 10px;
            background: rgba(74, 158, 255, 0.1);
            border-radius: 4px;
            font-size: 12px;
        }
        
        .collapsible {
            cursor: pointer;
            user-select: none;
        }
        
        .collapsible::before {
            content: '▼ ';
            display: inline-block;
            transition: transform 0.2s;
        }
        
        .collapsible.collapsed::before {
            transform: rotate(-90deg);
        }
        
        .collapsible-content {
            margin-top: 10px;
            padding-left: 15px;
        }
        
        .collapsible-content.hidden {
            display: none;
        }
    </style>
</head>
<body>
    <canvas id="canvas"></canvas>
    <div id="ui">
        <div class="control-group" style="margin-bottom: 20px; border-bottom: 1px solid #444; padding-bottom: 15px;">
            <div style="display: flex; gap: 10px; align-items: center;">
                <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                    <input type="radio" name="scene" id="scene2" value="1" checked onchange="switchScene(1)">
                    <span>Cloth Drop Test</span>
                </label>
                <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                    <input type="radio" name="scene" id="scene1" value="2" onchange="switchScene(2)">
                    <span>Cloth Wind Test</span>
                </label>
            </div>
            <div id="scene2Controls" style="display: none; margin-top: 10px;">
                <div style="display: flex; gap: 10px;">
                    <button onclick="resetClothToInitial()" style="flex: 1;">Before Drop</button>
                    <button onclick="dropCloth()" style="flex: 1; background: #4a9eff;">Drop!</button>
                </div>
            </div>
        </div>
        <h2>Cloth Simulation Controls</h2>
        <div class="info" id="fps">FPS: 0</div>
        
        <div class="control-group">
            <div class="collapsible" onclick="toggleCollapse(this)">Fixed Points</div>
            <div class="collapsible-content" id="fixed-points">
                <div class="button-group">
                    <button onclick="translateFixed(0, 0.05)">+X</button>
                    <button onclick="translateFixed(0, -0.05)">-X</button>
                </div>
                <div class="button-group">
                    <button onclick="translateFixed(1, 0.05)">+Y</button>
                    <button onclick="translateFixed(1, -0.05)">-Y</button>
                </div>
                <div class="button-group">
                    <button onclick="translateFixed(2, 0.05)">+Z</button>
                    <button onclick="translateFixed(2, -0.05)">-Z</button>
                </div>
                <div class="button-group">
                    <button onclick="rotateFixed(0, 0.02)">+RotX</button>
                    <button onclick="rotateFixed(0, -0.02)">-RotX</button>
                </div>
                <div class="button-group">
                    <button onclick="rotateFixed(1, 0.02)">+RotY</button>
                    <button onclick="rotateFixed(1, -0.02)">-RotY</button>
                </div>
                <div class="button-group">
                    <button onclick="rotateFixed(2, 0.02)">+RotZ</button>
                    <button onclick="rotateFixed(2, -0.02)">-RotZ</button>
                </div>
            </div>
        </div>
        
        <div class="control-group">
            <div class="collapsible" onclick="toggleCollapse(this)">Cloth Mode</div>
            <div class="collapsible-content" id="cloth-mode">
                <label style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                    <input type="radio" name="clothMode" id="modePhysics" value="physics" checked onchange="switchClothMode('physics')">
                    <span>Physics Mode (Particle-based simulation)</span>
                </label>
                <label style="display: flex; align-items: center; gap: 10px;">
                    <input type="radio" name="clothMode" id="modeSimple" value="simple" onchange="switchClothMode('simple')">
                    <span>Simple Triangle Mode (Static mesh)</span>
                </label>
            </div>
        </div>
        
        <div class="control-group">
            <div class="collapsible" onclick="toggleCollapse(this)">Cloth Coefficients</div>
            <div class="collapsible-content" id="cloth-coeffs">
                <label>Number of Particles: <input type="number" id="numParticles" step="1" min="5" max="39" value="25"></label>
                <label>Mass: <input type="number" id="mass" step="0.1" value="100"></label>
                <label>Gravity: <input type="number" id="gravity" step="0.1" value="2"></label>
                <label>Ground: <input type="number" id="ground" step="0.1" value="0"></label>
                <div style="font-size: 11px; color: #999; margin-top: 5px;">⚠️ Particle number is limited to 5~39 for performance</div>
            </div>
        </div>
        
        <div class="control-group" id="simple-cloth-controls" style="display: none;">
            <div class="collapsible" onclick="toggleCollapse(this)">Simple Triangle Mesh</div>
            <div class="collapsible-content">
                <div class="info" id="triangleCount" style="margin-top: 0px; margin-bottom: 10px;">Triangles: 1152</div>
                <label>Target Number of Triangles: <input type="number" id="numTriangles" step="2" min="2" max="10000" value="1000"></label>
                <input type="range" id="numTrianglesSlider" min="2" max="2000" step="2" value="1000" style="width: 100%; margin-top: 5px; margin-bottom: 5px;">
                <div style="font-size: 11px; color: #999; margin-top: 2px; margin-bottom: 5px;">Note: Will be adjusted to the closest functional actual triangle count</div>
                <label style="display: flex; align-items: center; gap: 10px; margin-top: 10px;">
                    <input type="checkbox" id="wireframeToggle">
                    <span>Show Wireframe Overlay (Cyan edges on cloth - thick quads)</span>
                </label>
                <div style="font-size: 11px; color: #999; margin-top: 5px;">⚠️ Higher values may cause performance issues</div>
            </div>
        </div>
        
        <div class="control-group">
            <div class="collapsible" onclick="toggleCollapse(this)">Spring-Damper</div>
            <div class="collapsible-content" id="spring-damper">
                <label>Spring Constant: <input type="number" id="springConst" step="10" value="1000"></label>
                <label>Damping Constant: <input type="number" id="dampingConst" step="0.1" value="3.5"></label>
            </div>
        </div>
        
        <div class="control-group">
            <div class="collapsible" onclick="toggleCollapse(this)">Aerodynamics</div>
            <div class="collapsible-content" id="aerodynamics">
                <label>Wind X: <input type="number" id="windX" step="0.1" value="0.5"></label>
                <label>Wind Y: <input type="number" id="windY" step="0.1" value="0.5"></label>
                <label>Wind Z: <input type="number" id="windZ" step="0.1" value="-2.5"></label>
                <label>Fluid Density: <input type="number" id="fluidDensity" step="0.01" value="1.225"></label>
                <label>Drag Coefficient: <input type="number" id="dragConst" step="0.1" value="1.0"></label>
            </div>
        </div>
        
        <div class="control-group">
            <div class="collapsible" onclick="toggleCollapse(this)">Lighting</div>
            <div class="collapsible-content" id="lighting">
                <div style="margin-bottom: 15px;">
                    <strong>Light 1</strong>
                    <label>Color R: <input type="number" id="light1R" step="0.1" min="0" max="1" value="1.0"></label>
                    <label>Color G: <input type="number" id="light1G" step="0.1" min="0" max="1" value="0.0"></label>
                    <label>Color B: <input type="number" id="light1B" step="0.1" min="0" max="1" value="0.0"></label>
                    <label>Position X: <input type="number" id="light1X" step="0.1" value="1"></label>
                    <label>Position Y: <input type="number" id="light1Y" step="0.1" value="-1.5"></label>
                    <label>Position Z: <input type="number" id="light1Z" step="0.1" value="2"></label>
                </div>
                <div>
                    <strong>Light 2</strong>
                    <label>Color R: <input type="number" id="light2R" step="0.1" min="0" max="1" value="0.4"></label>
                    <label>Color G: <input type="number" id="light2G" step="0.1" min="0" max="1" value="0.4"></label>
                    <label>Color B: <input type="number" id="light2B" step="0.1" min="0" max="1" value="0.4"></label>
                    <label>Position X: <input type="number" id="light2X" step="0.1" value="-1"></label>
                    <label>Position Y: <input type="number" id="light2Y" step="0.1" value="5"></label>
                    <label>Position Z: <input type="number" id="light2Z" step="0.1" value="-2"></label>
                </div>
            </div>
        </div>
        
        <div class="control-group">
            <div class="collapsible" onclick="toggleCollapse(this)">Colors</div>
            <div class="collapsible-content" id="colors">
                <div style="margin-bottom: 15px;">
                    <strong>Cloth Color</strong>
                    <label>R: <input type="number" id="clothR" step="0.01" min="0" max="1" value="0.9"></label>
                    <label>G: <input type="number" id="clothG" step="0.01" min="0" max="1" value="0.01"></label>
                    <label>B: <input type="number" id="clothB" step="0.01" min="0" max="1" value="0.01"></label>
                </div>
                <div>
                    <strong>Ground Color</strong>
                    <label>R: <input type="number" id="groundR" step="0.01" min="0" max="1" value="0.5"></label>
                    <label>G: <input type="number" id="groundG" step="0.01" min="0" max="1" value="0.4"></label>
                    <label>B: <input type="number" id="groundB" step="0.01" min="0" max="1" value="0.35"></label>
                </div>
            </div>
        </div>
        
        <div class="control-group">
            <button onclick="resetCamera()">Reset Camera (R)</button>
        </div>
    </div>
    
    <script type="module" src="/src/main.ts"></script>
    <script>
        function toggleCollapse(element) {
            element.classList.toggle('collapsed');
            const content = element.nextElementSibling;
            content.classList.toggle('hidden');
        }
        
        // These will be set by the main application
        let translateFixedFn, rotateFixedFn, resetCameraFn;
        
        function translateFixed(axis, shift) {
            if (translateFixedFn) translateFixedFn(axis, shift);
        }
        
        function rotateFixed(axis, shift) {
            if (rotateFixedFn) rotateFixedFn(axis, shift);
        }
        
        function resetCamera() {
            if (resetCameraFn) resetCameraFn();
        }
        
        // Export functions to be set by main.ts
        window.setupUICallbacks = (callbacks) => {
            translateFixedFn = callbacks.translateFixed;
            rotateFixedFn = callbacks.rotateFixed;
            resetCameraFn = callbacks.resetCamera;
        };
        
        window.updateFPS = (fps) => {
            document.getElementById('fps').textContent = `FPS: ${fps}`;
        };
        
        window.updateTriangleCount = (count) => {
            document.getElementById('triangleCount').textContent = `Triangles: ${count}`;
        };
        
        window.switchClothMode = (mode) => {
            if (window.switchModeFn) {
                window.switchModeFn(mode);
            }
        };
        
        window.toggleWireframe = () => {
            if (window.toggleWireframeFn) {
                window.toggleWireframeFn();
            }
        };
        
        window.setupUIControls = (updateCloth, updateLighting, updateColors, switchMode) => {
            window.switchModeFn = switchMode;
            
            const inputs = ['numParticles', 'numTriangles', 'mass', 'gravity', 'ground', 'springConst', 'dampingConst', 
                           'windX', 'windY', 'windZ', 'fluidDensity', 'dragConst'];
            inputs.forEach(id => {
                const input = document.getElementById(id);
                if (input) {
                    input.addEventListener('input', () => {
                        const value = parseFloat(input.value);
                        // Update triangle count display for particle count changes
                        if (id === 'numParticles') {
                            const clampedValue = Math.max(5, Math.min(39, Math.round(value)));
                            const triangleCount = 2 * (clampedValue - 1) * (clampedValue - 1);
                            if (window.updateTriangleCount) {
                                window.updateTriangleCount(triangleCount);
                            }
                        } else if (id === 'numTriangles') {
                            // Sync slider with input
                            const slider = document.getElementById('numTrianglesSlider');
                            if (slider) {
                                const clampedValue = Math.max(2, Math.min(2000, Math.round(value)));
                                slider.value = clampedValue;
                            }
                            // Triangle count will be updated after recreation
                        }
                        updateCloth(id, value);
                    });
                }
            });
            
            // Add slider for numTriangles
            const numTrianglesSlider = document.getElementById('numTrianglesSlider');
            const numTrianglesInput = document.getElementById('numTriangles');
            if (numTrianglesSlider && numTrianglesInput) {
                numTrianglesSlider.addEventListener('input', () => {
                    const value = parseFloat(numTrianglesSlider.value);
                    numTrianglesInput.value = value;
                    updateCloth('numTriangles', value);
                });
            }
            
            // Lighting controls
            const lightInputs = ['light1R', 'light1G', 'light1B', 'light1X', 'light1Y', 'light1Z',
                                'light2R', 'light2G', 'light2B', 'light2X', 'light2Y', 'light2Z'];
            lightInputs.forEach(id => {
                const input = document.getElementById(id);
                if (input) {
                    input.addEventListener('input', () => {
                        updateLighting();
                    });
                }
            });
            
            // Color controls
            const colorInputs = ['clothR', 'clothG', 'clothB', 'groundR', 'groundG', 'groundB'];
            colorInputs.forEach(id => {
                const input = document.getElementById(id);
                if (input) {
                    input.addEventListener('input', () => {
                        updateColors();
                    });
                }
            });
        };
    </script>
</body>
</html>

